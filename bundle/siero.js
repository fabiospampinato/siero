export default ()=>{var A=Object.defineProperty;var Rt=Object.getOwnPropertyDescriptor;var Et=Object.getOwnPropertyNames;var Pt=Object.prototype.hasOwnProperty;var jt=(o,t)=>{for(var e in t)A(o,e,{get:t[e],enumerable:!0})},vt=(o,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Et(t))!Pt.call(o,r)&&r!==e&&A(o,r,{get:()=>t[r],enumerable:!(i=Rt(t,r))||i.enumerable});return o};var Mt=o=>vt(A({},"__esModule",{value:!0}),o);var Kt={};jt(Kt,{default:()=>Ut});var T=class{constructor(t){this.siero=t}},x=T;var R=class extends x{constructor(){super(...arguments);this.commands={};this.call=(e,i)=>{let r=this.commands[e];if(!r)throw new Error(`Command not found: "${e}"`);return r(...i)};this.has=e=>e in this.commands;this.register=(e,i)=>{if(this.has(e))throw new Error(`Command already registered: "${e}"`);return this.commands[e]=i,()=>{delete this.commands[e]}}}},Pe=R;var E=class extends x{constructor(){super(...arguments);this.functionCounter=1;this.functionResultCounter=1;this.function2id=new Map;this.id2function={};this.id2functionResult={};this.promiseCounter=1;this.promise2id=new Map;this.id2promise={};this.id2promiseRealms={};this.symbolCounter=1;this.symbol2id={};this.id2symbol={}}},je=E;var P=class extends x{constructor(){super(...arguments);this.pack=e=>{let i="",r="";for(let s=0,n=e.length;s<n;s++){let a=e[s],p=a.length;i+=s?`,${p}`:p,r+=a}return`${i}:${r}`};this.unpack=e=>{let i=e.indexOf(":"),r=e.slice(0,i),s=e.slice(i+1),n=r.length?r.split(","):[],a=new Array(n.length),p=0;for(let c=0,f=n.length;c<f;c++){let m=parseInt(n[c]),z=p,S=p+m,b=s.slice(z,S);a[c]=b,p=S}return a}}},ve=P;var j=class extends x{constructor(){super(...arguments);this.realms={};this.call=(e,i,r)=>{let s=this.realms[e];if(!s)throw new Error(`Realm not found: "${e}"`);return s(i,this.siero.serialize(r,{realm:e}))};this.has=e=>e in this.realms;this.register=(e,i)=>{if(this.has(e))throw new Error(`Realm already registered: "${e}"`);return this.realms[e]=i,()=>{delete this.realms[e]}}}},Me=j;var v=class{constructor(t){this.siero=t}},l=v;var M=class extends l{has(t,e){return e.value2reference.has(t)}register(t,e){let i=`${e.referenceCounter++}`;e.value2reference.set(t,i),e.reference2value.set(i,t)}serialize(t,e,i){let r=i.value2reference.get(t);if(!r)throw new Error("Reference for value not found");return r}deserialize(t,e,i){let r=i.reference2value.get(t);if(!r)throw new Error("Referenced value not found");return r}},Ne=M;var N=class extends l{constructor(){super(...arguments);this.typeof="bigint"}serialize(e,i,r){return e.toString()}deserialize(e,i,r){return BigInt(e)}},$e=N;var $=class extends l{constructor(){super(...arguments);this.typeof="boolean"}serialize(e,i,r){return e?"1":"0"}deserialize(e,i,r){return e==="1"}},Fe=$;var F=class extends l{constructor(){super(...arguments);this.value=null}serialize(e,i,r){return""}deserialize(e,i,r){return null}},Be=F;var B=class extends l{constructor(){super(...arguments);this.typeof="number"}serialize(e,i,r){return e===1/0?"I":e===-1/0?"-I":Object.is(e,NaN)?"N":Object.is(e,-0)?"-0":e.toString()}deserialize(e,i,r){return e==="I"?1/0:e==="-I"?-1/0:e==="N"?NaN:e==="-0"?-0:Number(e)}},Ue=B;var U=class extends l{constructor(){super(...arguments);this.typeof="string"}serialize(e,i,r){return e}deserialize(e,i,r){return e}},Ke=U;var K=class{constructor(){this.name2symbol={},this.symbol2name={},this.names=[],this.symbols=[],this.getNames=()=>this.names,this.getSymbols=()=>this.symbols,this.getName=e=>this.symbol2name[e],this.getSymbol=e=>this.name2symbol[e],this.hasName=e=>e in this.name2symbol,this.hasSymbol=e=>e in this.symbol2name;let t=Object.getOwnPropertyDescriptors(Symbol);for(let e in t){let i=t[e].value;typeof i=="symbol"&&(this.name2symbol[e]=i,this.symbol2name[i]=e,this.names.push(e),this.symbols.push(i))}}},L=new K;var V=class extends l{constructor(){super(...arguments);this.typeof="symbol"}serialize(e,i,r){let s=L.getName(e);if(s)return s;let n=this.siero.contexts.symbol2id[e]||=`${this.siero.realm}-${this.siero.contexts.symbolCounter++}`,a=this.siero.contexts.id2symbol[n]||=e;return n}deserialize(e,i,r){let s=L.getSymbol(e);if(s)return s;let n=this.siero.contexts.id2symbol[e]||=Symbol(),a=this.siero.contexts.symbol2id[n]||=e;return n}},Le=V;var G=class extends l{constructor(){super(...arguments);this.typeof="undefined"}serialize(e,i,r){return""}deserialize(e,i,r){}},Ve=G;var H=class extends l{constructor(t,e){super(t),this.Constructor=e}serialize(t,e,i){return this.siero.serializer.register(t,i),this.siero.serializer.serialize(t.valueOf(),e,i)}deserialize(t,e,i){let r=Object(this.siero.serializer.deserialize(t,e,i));return this.siero.serializer.register(r,i),r}},h=H;var W=class extends h{constructor(t){super(t,BigInt)}},Ge=W;var Y=class extends h{constructor(t){super(t,Boolean)}},He=Y;var X=class extends h{constructor(t){super(t,Number)}},We=X;var Z=class extends h{constructor(t){super(t,String)}},Ye=Z;var q=class extends h{constructor(t){super(t,Symbol)}},Xe=q;var J=class extends l{constructor(){super(...arguments);this.Constructor=Array}serialize(e,i,r){this.siero.serializer.register(e,r);let s=new Array(e.length);for(let a=0,p=e.length;a<p;a++)a in e?s[a]=this.siero.serializer.serialize(e[a],i,r):s[a]="";return this.siero.packer.pack(s)}deserialize(e,i,r){let s=this.siero.packer.unpack(e),n=new Array(s.length);this.siero.serializer.register(n,r);for(let a=0,p=s.length;a<p;a++)s[a]&&(n[a]=this.siero.serializer.deserialize(s[a],i,r));return n}},Ze=J;var Q=class extends l{constructor(){super(...arguments);this.Constructor=ArrayBuffer}serialize(e,i,r){return this.siero.serializer.register(e,r),new Uint8Array(e).toString()}deserialize(e,i,r){let s=e?e.split(",").map(Number):[],a=new Uint8Array(s).buffer;return this.siero.serializer.register(a,r),a}},qe=Q;var _=class extends l{constructor(){super(...arguments);this.Constructor=Date}serialize(e,i,r){return this.siero.serializer.register(e,r),e.getTime().toString()}deserialize(e,i,r){let s=new Date(parseInt(e));return this.siero.serializer.register(s,r),s}},Je=_;var g=o=>Array.isArray(o)?o:[o],_e=()=>Math.random().toString(36).slice(2).slice(0,12).padStart(12,"0"),C=(o,t,e)=>{let i=o.get(t);if(i||o.has(t))return i;let r=e();return o.set(t,r),r},Qe=()=>{},I=()=>{let o=Qe,t=Qe;return{promise:new Promise((i,r)=>{o=i,t=r}),resolve:o,reject:t}};var ee=class extends l{constructor(e){super(e);this.typeof="function";this.siero.commands.register("function.call",this.call.bind(this)),this.siero.commands.register("function.settle",this.settle.bind(this))}call(e,...i){let[r,s,n,a]=e.split("-"),p=this.siero.contexts.id2function[`${s}-${n}`];if(!p)this.siero.realms.call(r,"function.settle",[e,!1,new ReferenceError("Function not found")]);else try{let c=p(...i);if(c instanceof Promise){let f=z=>this.siero.realms.call(r,"function.settle",[e,!0,z]),m=z=>this.siero.realms.call(r,"function.settle",[e,!1,z]);c.then(f,m)}else this.siero.realms.call(r,"function.settle",[e,!0,c])}catch(c){this.siero.realms.call(r,"function.settle",[e,!1,c])}}settle(e,i,r){let s=this.siero.contexts.id2functionResult[e];s&&(delete this.siero.contexts.id2functionResult[e],i?s.resolve(r):s.reject(r))}serialize(e,i,r){let s=C(this.siero.contexts.function2id,e,()=>`${this.siero.realm}-${this.siero.contexts.functionCounter++}`),n=this.siero.contexts.id2function[s]||=async(...c)=>e(...c),a=C(this.siero.contexts.function2id,n,()=>s);return this.siero.packer.pack([e.name,`${e.length}`,s])}deserialize(e,i,r){let[s,n,a]=this.siero.packer.unpack(e),[p,c]=a.split("-"),f=this.siero.contexts.id2function[a];if(f)return f;let m=this.siero.contexts.id2function[a]=(...S)=>{let b=this.siero.realm,k=this.siero.contexts.functionResultCounter++,d=`${b}-${p}-${c}-${k}`,O=I();return this.siero.contexts.id2functionResult[d]=O,this.siero.realms.call(p,"function.call",[d,...S]),O.promise};Object.defineProperty(m,"name",{value:s}),Object.defineProperty(m,"length",{value:parseInt(n)});let z=C(this.siero.contexts.function2id,m,()=>a);return m}},et=ee;var te=class extends l{constructor(){super(...arguments);this.Constructor=Map}serialize(e,i,r){this.siero.serializer.register(e,r);let s=this.siero.serializer.serialize(Array.from(e.keys()),i,r),n=this.siero.serializer.serialize(Array.from(e.values()),i,r);return this.siero.packer.pack([s,n])}deserialize(e,i,r){let s=new Map;this.siero.serializer.register(s,r);let n=this.siero.packer.unpack(e),a=g(this.siero.serializer.deserialize(n[0],i,r)),p=g(this.siero.serializer.deserialize(n[1],i,r));for(let c=0,f=a.length;c<f;c++)s.set(a[c],p[c]);return s}},tt=te;var re=class extends l{constructor(e){super(e);this.Constructor=Promise;this.siero.commands.register("promise.settle",this.settle.bind(this))}settle(e,i,r){let s=this.siero.contexts.id2promiseRealms[e];if(s){delete this.siero.contexts.id2promiseRealms[e];for(let a of s)a!==this.siero.realm&&this.siero.realms.has(a)&&this.siero.realms.call(a,"promise.settle",[e,i,r])}let n=this.siero.contexts.id2promise[e];n&&(delete this.siero.contexts.id2promise[e],this.siero.contexts.promise2id.delete(n.promise),i?n.resolve(r):n.reject(r))}serialize(e,i,r){let s=C(this.siero.contexts.promise2id,e,()=>`${this.siero.realm}-${this.siero.contexts.promiseCounter++}`),n=s in this.siero.contexts.id2promise,a=this.siero.contexts.id2promise[s]||=I();if(i?.realm&&(this.siero.contexts.id2promiseRealms[s]||=new Set).add(i.realm),!n){let p=f=>this.settle(s,!0,f),c=f=>this.settle(s,!1,f);e.then(p,c)}return s}deserialize(e,i,r){let s=this.siero.contexts.id2promise[e]||=I(),n=C(this.siero.contexts.promise2id,s.promise,()=>e);return s.promise}},rt=re;var ie=class extends l{constructor(){super(...arguments);this.Constructor=RegExp}serialize(e,i,r){this.siero.serializer.register(e,r);let{source:s,flags:n}=e;return this.siero.packer.pack([s,n])}deserialize(e,i,r){let s=this.siero.packer.unpack(e),[n,a]=s,p=new RegExp(n,a);return this.siero.serializer.register(p,r),p}},it=ie;var se=class extends l{constructor(){super(...arguments);this.Constructor=Set}serialize(e,i,r){this.siero.serializer.register(e,r);let s=Array.from(e.values());return this.siero.serializer.serialize(s,i,r)}deserialize(e,i,r){let s=new Set;this.siero.serializer.register(s,r);let n=g(this.siero.serializer.deserialize(e,i,r));for(let a=0,p=n.length;a<p;a++)s.add(n[a]);return s}},st=se;var oe=class extends l{constructor(t,e){super(t),this.Constructor=e}serialize(t,e,i){this.siero.serializer.register(t,i);let r=t.name,s=t.message,n=t.stack||"",a=t.cause?this.siero.serializer.serialize(t.cause,e,i):"";return this.siero.packer.pack([r,s,n,a])}deserialize(t,e,i){let r=new this.Constructor;this.siero.serializer.register(r,i);let s=this.siero.packer.unpack(t),[n,a,p,c]=s;return r.name=n,r.message=a,r.stack=p,r.cause=c?this.siero.serializer.deserialize(c,e,i):void 0,r}},y=oe;var ne=class extends y{constructor(t){super(t,EvalError)}},ot=ne;var ae=class extends y{constructor(t){super(t,RangeError)}},nt=ae;var le=class extends y{constructor(t){super(t,ReferenceError)}},at=le;var pe=class extends y{constructor(t){super(t,SyntaxError)}},lt=pe;var ce=class extends y{constructor(t){super(t,TypeError)}},pt=ce;var me=class extends y{constructor(t){super(t,URIError)}},ct=me;var ue=class extends y{constructor(t){super(t,Error)}},mt=ue;var fe=class extends l{constructor(t,e,i){super(t),this.Constructor=e,this.Parser=i}serialize(t,e,i){return this.siero.serializer.register(t,i),t.toString()}deserialize(t,e,i){let r=t?t.split(",").map(this.Parser):[],s=new this.Constructor(r);return this.siero.serializer.register(s,i),s}},w=fe;var de=class extends w{constructor(t,e){super(t,e,BigInt)}},D=de;var ye=class extends D{constructor(t){super(t,BigInt64Array)}},ut=ye;var ze=class extends D{constructor(t){super(t,BigUint64Array)}},ft=ze;var xe=class extends w{constructor(t,e){super(t,e,Number)}},u=xe;var he=class extends u{constructor(t){super(t,Float32Array)}},dt=he;var ge=class extends u{constructor(t){super(t,Float64Array)}},yt=ge;var Se=class extends u{constructor(t){super(t,Int8Array)}},zt=Se;var be=class extends u{constructor(t){super(t,Int16Array)}},xt=be;var Ce=class extends u{constructor(t){super(t,Int32Array)}},ht=Ce;var Oe=class extends u{constructor(t){super(t,Uint8Array)}},gt=Oe;var Ie=class extends u{constructor(t){super(t,Uint16Array)}},St=Ie;var ke=class extends u{constructor(t){super(t,Uint32Array)}},bt=ke;var we=class extends u{constructor(t){super(t,Uint8ClampedArray)}},Ct=we;var Nt=o=>Object.getPrototypeOf(o)===null,{isExtensible:$t,isFrozen:Ft,isSealed:Bt}=Object,Ot=1,It=2,kt=4,wt=8,De=class extends l{constructor(){super(...arguments);this.Constructor=Object;this.typeof="object"}serialize(e,i,r){this.siero.serializer.register(e,r);let s=Nt(e)?Ot:0,n=$t(e)?It:0,a=Ft(e)?kt:0,p=Bt(e)?wt:0,c=`${s|n|a|p}`,f=this.siero.packer.pack(Object.keys(e)),m=this.siero.serializer.serialize(Object.values(e),i,r),z=Object.getOwnPropertySymbols(e),S=this.siero.serializer.serialize(z,i,r),b=this.siero.serializer.serialize(z.map(d=>e[d]),i,r);return this.siero.packer.pack([c,f,m,S,b])}deserialize(e,i,r){let s=this.siero.packer.unpack(e),n=parseInt(s[0]),a=n&Ot,p=n&It,c=n&kt,f=n&wt,m=a?Object.create(null):{};this.siero.serializer.register(m,r);let z=this.siero.packer.unpack(s[1]),S=g(this.siero.serializer.deserialize(s[2],i,r)),b=g(this.siero.serializer.deserialize(s[3],i,r)),k=g(this.siero.serializer.deserialize(s[4],i,r));for(let d=0,O=z.length;d<O;d++)m[z[d]]=S[d];for(let d=0,O=b.length;d<O;d++)m[b[d]]=k[d];return p||Object.preventExtensions(m),c&&Object.freeze(m),f&&Object.seal(m),m}},Dt=De;var At=[Ne,$e,Fe,Be,Ue,Ke,Le,Ve,Ge,He,We,Ye,Xe,Ze,qe,Je,et,tt,rt,it,st,ot,nt,at,lt,pt,ct,mt,ut,ft,dt,yt,zt,xt,ht,gt,St,bt,Ct,Dt];var Ae=class extends x{constructor(e){super(e);this.infer=(e,i)=>{if(e===null)return this.value2type.get(e);let r=typeof e,s=e?.constructor;return(r==="object"||r==="function")&&this.reference.has(e,i)?this.reference:r==="object"&&s!==void 0?this.constructor2type.get(s):this.typeof2type.get(r)};this.register=(e,i)=>{this.reference.register(e,i)};this.serialize=(e,i,r)=>{let s=this.infer(e,r);if(!s)throw new Error("Unserializable value");let n=this.type2id.get(s),a=s.serialize(e,i,r);return`${n}${a}`};this.deserialize=(e,i,r)=>{let s=e[0],n=e.slice(1),a=this.id2type.get(s);if(!a)throw new Error("Undeserializable value");return a.deserialize(n,i,r)};let i="@ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",r=At;if(r.length>=i.length)throw new Error(`More than ${i.length} types are not supported`);this.types=r.map(s=>new s(e)),this.type2id=new Map(this.types.map((s,n)=>[s,i[n]])),this.id2type=new Map(this.types.map((s,n)=>[i[n],s])),this.typeof2type=new Map(this.types.map(s=>[s.typeof,s])),this.constructor2type=new Map(this.types.map(s=>[s.Constructor,s])),this.value2type=new Map(this.types.map(s=>[s.value,s])),this.reference=this.types[0]}},Tt=Ae;var Te=class{constructor(){this.referenceCounter=1;this.value2reference=new Map;this.reference2value=new Map}},Re=Te;var Ee=class{constructor(t={}){this.call=(t,e)=>{this.commands.call(t,e)};this.register=(t,e)=>this.realms.register(t,e);this.serialize=(t,e={})=>this.serializer.serialize(t,e,new Re);this.deserialize=(t,e={})=>this.serializer.deserialize(t,e,new Re);this.realm=t.realm??_e(),this.commands=new Pe(this),this.contexts=new je(this),this.packer=new ve(this),this.realms=new Me(this),this.serializer=new Tt(this)}},Ut=Ee;return Mt(Kt);};
