export default ()=>{var E=Object.defineProperty;var Ur=Object.getOwnPropertyDescriptor;var Vr=Object.getOwnPropertyNames;var Lr=Object.prototype.hasOwnProperty;var Wr=(o,r)=>{for(var e in r)E(o,e,{get:r[e],enumerable:!0})},Kr=(o,r,e,i)=>{if(r&&typeof r=="object"||typeof r=="function")for(let t of Vr(r))!Lr.call(o,t)&&t!==e&&E(o,t,{get:()=>r[t],enumerable:!(i=Ur(r,t))||i.enumerable});return o};var Gr=o=>Kr(E({},"__esModule",{value:!0}),o);var Jr={};Wr(Jr,{default:()=>qr});var v=class{constructor(r){this.siero=r}},y=v;var P=class extends y{constructor(){super(...arguments);this.commands={};this.call=(e,i)=>{let t=this.commands[e];if(!t)throw new Error(`Command not found: "${e}"`);return t(...i)};this.has=e=>e in this.commands;this.register=(e,i)=>{if(this.has(e))throw new Error(`Command already registered: "${e}"`);return this.commands[e]=i,()=>{delete this.commands[e]}}}},Me=P;var j=class extends y{constructor(){super(...arguments);this.functionCounter=1;this.functionResultCounter=1;this.function2id=new Map;this.id2function={};this.id2functionResult={};this.promiseCounter=1;this.promise2id=new Map;this.id2promise={};this.id2promiseRealms={};this.symbolCounter=1;this.symbol2id={};this.id2symbol={}}},Fe=j;var $=class extends y{constructor(){super(...arguments);this.pack=e=>{let i="",t="";for(let s=0,n=e.length;s<n;s++){let a=e[s],p=a.length;i+=s?`,${p}`:p,t+=a}return`${i}:${t}`};this.unpack=e=>{let i=e.indexOf(":"),t=e.slice(0,i),s=e.slice(i+1),n=t.length?t.split(","):[],a=new Array(n.length),p=0;for(let c=0,m=n.length;c<m;c++){let f=parseInt(n[c]),g=p,S=p+f,b=s.slice(g,S);a[c]=b,p=S}return a}}},Ue=$;var B=class extends y{constructor(){super(...arguments);this.realms={};this.call=(e,i,t)=>{let s=this.realms[e];if(!s)throw new Error(`Realm not found: "${e}"`);return s(i,this.siero.serialize(t,{realm:e}))};this.has=e=>e in this.realms;this.register=(e,i)=>{if(this.has(e))throw new Error(`Realm already registered: "${e}"`);return this.realms[e]=i,()=>{delete this.realms[e]}}}},Ve=B;var N=class{constructor(r){this.siero=r}},l=N;var M=class extends l{isSerialized(r,e){return e.value2reference.has(r)}serialized(r,e){e.value2reference.set(r,e.referenceCounter++)}deserialized(r,e){e.reference2value.push(r)}serialize(r,e,i){let t=i.value2reference.get(r);if(!t)throw new Error("Reference for value not found");return`${t}`}deserialize(r,e,i){let t=i.reference2value[parseInt(r)];if(!t)throw new Error("Referenced value not found");return t}},Le=M;var D=class{constructor(r){this.value=r}},F=class extends l{constructor(){super(...arguments);this.Constructor=D}wrap(e){return new D(e)}serialize(e,i,t){return e.value}deserialize(e,i,t){return this.siero.serializer.deserialize(e,i,t)}},We=F;var U=class extends l{constructor(){super(...arguments);this.typeof="bigint"}serialize(e,i,t){return e.toString()}deserialize(e,i,t){return BigInt(e)}},Ke=U;var V=class extends l{constructor(){super(...arguments);this.typeof="boolean"}serialize(e,i,t){return e?"1":"0"}deserialize(e,i,t){return e==="1"}},Ge=V;var L=class extends l{constructor(){super(...arguments);this.value=null}serialize(e,i,t){return""}deserialize(e,i,t){return null}},He=L;var W=class extends l{constructor(){super(...arguments);this.typeof="number"}serialize(e,i,t){return e===1/0?"I":e===-1/0?"-I":Object.is(e,NaN)?"N":Object.is(e,-0)?"-0":e.toString()}deserialize(e,i,t){return e==="I"?1/0:e==="-I"?-1/0:e==="N"?NaN:e==="-0"?-0:Number(e)}},Ye=W;var K=class extends l{constructor(){super(...arguments);this.typeof="string"}serialize(e,i,t){return e}deserialize(e,i,t){return e}},Xe=K;var G=class{constructor(){this.name2symbol={},this.symbol2name={},this.names=[],this.symbols=[],this.getNames=()=>this.names,this.getSymbols=()=>this.symbols,this.getName=e=>this.symbol2name[e],this.getSymbol=e=>this.name2symbol[e],this.hasName=e=>e in this.name2symbol,this.hasSymbol=e=>e in this.symbol2name;let r=Object.getOwnPropertyDescriptors(Symbol);for(let e in r){let i=r[e].value;typeof i=="symbol"&&(this.name2symbol[e]=i,this.symbol2name[i]=e,this.names.push(e),this.symbols.push(i))}}},H=new G;var Y=class extends l{constructor(){super(...arguments);this.typeof="symbol"}serialize(e,i,t){let s=H.getName(e);if(s)return s;let n=this.siero.contexts.symbol2id[e]||=`${this.siero.realm}-${this.siero.contexts.symbolCounter++}`,a=this.siero.contexts.id2symbol[n]||=e;return n}deserialize(e,i,t){let s=H.getSymbol(e);if(s)return s;let n=this.siero.contexts.id2symbol[e]||=Symbol(),a=this.siero.contexts.symbol2id[n]||=e;return n}},Ze=Y;var X=class extends l{constructor(){super(...arguments);this.typeof="undefined"}serialize(e,i,t){return""}deserialize(e,i,t){}},qe=X;var Z=class extends l{constructor(r,e){super(r),this.Constructor=e}serialize(r,e,i){return this.siero.serializer.serialized(r,i),this.siero.serializer.serialize(r.valueOf(),e,i)}deserialize(r,e,i){let t=Object(this.siero.serializer.deserialize(r,e,i));return this.siero.serializer.deserialized(t,i),t}},x=Z;var q=class extends x{constructor(r){super(r,BigInt)}},Je=q;var J=class extends x{constructor(r){super(r,Boolean)}},Qe=J;var Q=class extends x{constructor(r){super(r,Number)}},_e=Q;var _=class extends x{constructor(r){super(r,String)}},er=_;var ee=class extends x{constructor(r){super(r,Symbol)}},rr=ee;var re=class extends l{constructor(){super(...arguments);this.Constructor=Array}serialize(e,i,t){this.siero.serializer.serialized(e,t);let s=new Array(e.length);for(let a=0,p=e.length;a<p;a++)a in e?s[a]=this.siero.serializer.serialize(e[a],i,t):s[a]="";return this.siero.packer.pack(s)}deserialize(e,i,t){let s=this.siero.packer.unpack(e),n=new Array(s.length);this.siero.serializer.deserialized(n,t);for(let a=0,p=s.length;a<p;a++)s[a]&&(n[a]=this.siero.serializer.deserialize(s[a],i,t));return n}},tr=re;var te=class extends l{constructor(){super(...arguments);this.Constructor=ArrayBuffer}serialize(e,i,t){return this.siero.serializer.serialized(e,t),new Uint8Array(e).toString()}deserialize(e,i,t){let s=e?e.split(",").map(Number):[],a=new Uint8Array(s).buffer;return this.siero.serializer.deserialized(a,t),a}},ir=te;var ie=class extends l{constructor(){super(...arguments);this.Constructor=DataView}serialize(e,i,t){let s=this.siero.serializer.serialize(e.buffer,i,t),n=`${e.byteOffset}`,a=`${e.byteLength}`,p=this.siero.packer.pack([s,n,a]);return this.siero.serializer.serialized(e,t),p}deserialize(e,i,t){let s=this.siero.packer.unpack(e),n=this.siero.serializer.deserialize(s[0],i,t),a=parseInt(s[1]),p=parseInt(s[2]),c=new DataView(n,a,p);return this.siero.serializer.deserialized(c,t),c}},sr=ie;var se=class extends l{constructor(){super(...arguments);this.Constructor=Date}serialize(e,i,t){return this.siero.serializer.serialized(e,t),e.getTime().toString()}deserialize(e,i,t){let s=new Date(parseInt(e));return this.siero.serializer.deserialized(s,t),s}},or=se;var h=o=>Array.isArray(o)?o:[o],ar=()=>Math.random().toString(36).slice(2).slice(0,12).padStart(12,"0"),C=(o,r,e)=>{let i=o.get(r);if(i||o.has(r))return i;let t=e();return o.set(r,t),t},nr=()=>{},k=()=>{let o=nr,r=nr;return{promise:new Promise((i,t)=>{o=i,r=t}),resolve:o,reject:r}},lr=(o,r,e)=>{if(!o)e(!1,new ReferenceError("function is not found"));else try{let i=o(...r);if(i instanceof Promise){let t=n=>e(!0,n),s=n=>e(!1,n);i.then(t,s)}else e(!0,i)}catch(i){e(!1,i)}};var oe=class{constructor(){this.referenceCounter=0;this.value2reference=new Map;this.reference2value=[]}},w=oe;var ne=class extends l{constructor(e){super(e);this.typeof="function";this.siero.commands.register("function.call",this.call.bind(this)),this.siero.commands.register("function.settle",this.settle.bind(this))}call(e,...i){let[t,s,n,a]=e.split("-"),p=this.siero.contexts.id2function[`${s}-${n}`];lr(p,i,(c,m)=>{this.siero.realms.call(t,"function.settle",[e,...this.siero.serializer.normalize(c,m,{realm:t},new w)])})}settle(e,i,t){let s=this.siero.contexts.id2functionResult[e];s&&(delete this.siero.contexts.id2functionResult[e],i?s.resolve(t):s.reject(t))}serialize(e,i,t){let s=C(this.siero.contexts.function2id,e,()=>`${this.siero.realm}-${this.siero.contexts.functionCounter++}`),n=this.siero.contexts.id2function[s]||=async(...c)=>e(...c),a=C(this.siero.contexts.function2id,n,()=>s);return this.siero.packer.pack([e.name,`${e.length}`,s])}deserialize(e,i,t){let[s,n,a]=this.siero.packer.unpack(e),[p,c]=a.split("-"),m=this.siero.contexts.id2function[a];if(m)return m;let f=this.siero.contexts.id2function[a]=(...S)=>{let b=this.siero.realm,I=this.siero.contexts.functionResultCounter++,d=`${b}-${p}-${c}-${I}`,O=k();return this.siero.contexts.id2functionResult[d]=O,this.siero.realms.call(p,"function.call",[d,...S]),O.promise};Object.defineProperty(f,"name",{value:s}),Object.defineProperty(f,"length",{value:parseInt(n)});let g=C(this.siero.contexts.function2id,f,()=>a);return f}},pr=ne;var ae=class extends l{constructor(){super(...arguments);this.Constructor=Map}serialize(e,i,t){this.siero.serializer.serialized(e,t);let s=this.siero.serializer.serialize(Array.from(e.keys()),i,t),n=this.siero.serializer.serialize(Array.from(e.values()),i,t);return this.siero.packer.pack([s,n])}deserialize(e,i,t){let s=new Map;this.siero.serializer.deserialized(s,t);let n=this.siero.packer.unpack(e),a=h(this.siero.serializer.deserialize(n[0],i,t)),p=h(this.siero.serializer.deserialize(n[1],i,t));for(let c=0,m=a.length;c<m;c++)s.set(a[c],p[c]);return s}},cr=ae;var le=class extends l{constructor(e){super(e);this.Constructor=Promise;this.siero.commands.register("promise.settle",this.settle.bind(this))}settle(e,i,t){let s=this.siero.contexts.id2promiseRealms[e];if(s){delete this.siero.contexts.id2promiseRealms[e];for(let a of s)a!==this.siero.realm&&this.siero.realms.has(a)&&this.siero.realms.call(a,"promise.settle",[e,...this.siero.serializer.normalize(i,t,{realm:a},new w)])}let n=this.siero.contexts.id2promise[e];n&&(delete this.siero.contexts.id2promise[e],this.siero.contexts.promise2id.delete(n.promise),i?n.resolve(t):n.reject(t))}serialize(e,i,t){let s=C(this.siero.contexts.promise2id,e,()=>`${this.siero.realm}-${this.siero.contexts.promiseCounter++}`),n=s in this.siero.contexts.id2promise,a=this.siero.contexts.id2promise[s]||=k();if(i?.realm&&(this.siero.contexts.id2promiseRealms[s]||=new Set).add(i.realm),!n){let p=m=>this.settle(s,!0,m),c=m=>this.settle(s,!1,m);e.then(p,c)}return s}deserialize(e,i,t){let s=this.siero.contexts.id2promise[e]||=k(),n=C(this.siero.contexts.promise2id,s.promise,()=>e);return s.promise}},mr=le;var pe=class extends l{constructor(){super(...arguments);this.Constructor=RegExp}serialize(e,i,t){this.siero.serializer.serialized(e,t);let{source:s,flags:n}=e;return this.siero.packer.pack([s,n])}deserialize(e,i,t){let s=this.siero.packer.unpack(e),[n,a]=s,p=new RegExp(n,a);return this.siero.serializer.deserialized(p,t),p}},ur=pe;var ce=class extends l{constructor(){super(...arguments);this.Constructor=Set}serialize(e,i,t){this.siero.serializer.serialized(e,t);let s=Array.from(e.values());return this.siero.serializer.serialize(s,i,t)}deserialize(e,i,t){let s=new Set;this.siero.serializer.deserialized(s,t);let n=h(this.siero.serializer.deserialize(e,i,t));for(let a=0,p=n.length;a<p;a++)s.add(n[a]);return s}},fr=ce;var me=class extends l{constructor(r,e,i){super(r),this.Constructor=e,this.Instantiator=i}serialize(r,e,i){this.siero.serializer.serialized(r,i);let t=r.name,s=r.message,n=r.stack||"",a=r.cause?this.siero.serializer.serialize(r.cause,e,i):"",p=Array.isArray(r.errors)?this.siero.serializer.serialize(r.errors,e,i):"";return this.siero.packer.pack([t,s,n,a,p])}deserialize(r,e,i){let t=this.Instantiator();this.siero.serializer.deserialized(t,i);let s=this.siero.packer.unpack(r),[n,a,p,c,m]=s;return t.name=n,t.message=a,t.stack=p,t.cause=c?this.siero.serializer.deserialize(c,e,i):void 0,t.errors=m?this.siero.serializer.deserialize(m,e,i):void 0,t}},A=me;var ue=class extends A{constructor(r){super(r,AggregateError,()=>new AggregateError([]))}},dr=ue;var fe=class extends A{constructor(r,e){super(r,e,()=>new e)}},z=fe;var de=class extends z{constructor(r){super(r,EvalError)}},zr=de;var ze=class extends z{constructor(r){super(r,RangeError)}},yr=ze;var ye=class extends z{constructor(r){super(r,ReferenceError)}},xr=ye;var xe=class extends z{constructor(r){super(r,SyntaxError)}},hr=xe;var he=class extends z{constructor(r){super(r,TypeError)}},gr=he;var ge=class extends z{constructor(r){super(r,URIError)}},Sr=ge;var Se=class extends z{constructor(r){super(r,Error)}},br=Se;var be=class extends l{constructor(r,e,i){super(r),this.Constructor=e,this.Parser=i}serialize(r,e,i){let t=this.siero.serializer.serialize(r.buffer,e,i),s=`${r.byteOffset}`,n=`${r.length}`,a=this.siero.packer.pack([t,s,n]);return this.siero.serializer.serialized(r,i),a}deserialize(r,e,i){let t=this.siero.packer.unpack(r),s=this.siero.serializer.deserialize(t[0],e,i),n=parseInt(t[1]),a=parseInt(t[2]),p=new this.Constructor(s,n,a);return this.siero.serializer.deserialized(p,i),p}},T=be;var Ce=class extends T{constructor(r,e){super(r,e,BigInt)}},R=Ce;var we=class extends R{constructor(r){super(r,BigInt64Array)}},Cr=we;var Oe=class extends R{constructor(r){super(r,BigUint64Array)}},wr=Oe;var ke=class extends T{constructor(r,e){super(r,e,Number)}},u=ke;var Ie=class extends u{constructor(r){super(r,Float32Array)}},Or=Ie;var De=class extends u{constructor(r){super(r,Float64Array)}},kr=De;var Ae=class extends u{constructor(r){super(r,Int8Array)}},Ir=Ae;var Te=class extends u{constructor(r){super(r,Int16Array)}},Dr=Te;var Re=class extends u{constructor(r){super(r,Int32Array)}},Ar=Re;var Ee=class extends u{constructor(r){super(r,Uint8Array)}},Tr=Ee;var ve=class extends u{constructor(r){super(r,Uint16Array)}},Rr=ve;var Pe=class extends u{constructor(r){super(r,Uint32Array)}},Er=Pe;var je=class extends u{constructor(r){super(r,Uint8ClampedArray)}},vr=je;var Hr=o=>Object.getPrototypeOf(o)===null,{isExtensible:Yr,isFrozen:Xr,isSealed:Zr}=Object,Pr=1,jr=2,$r=4,Br=8,$e=class extends l{constructor(){super(...arguments);this.Constructor=Object;this.typeof="object"}serialize(e,i,t){this.siero.serializer.serialized(e,t);let s=Hr(e)?Pr:0,n=Yr(e)?jr:0,a=Xr(e)?$r:0,p=Zr(e)?Br:0,c=`${s|n|a|p}`,m=this.siero.packer.pack(Object.keys(e)),f=this.siero.serializer.serialize(Object.values(e),i,t),g=Object.getOwnPropertySymbols(e),S=this.siero.serializer.serialize(g,i,t),b=this.siero.serializer.serialize(g.map(d=>e[d]),i,t);return this.siero.packer.pack([c,m,f,S,b])}deserialize(e,i,t){let s=this.siero.packer.unpack(e),n=parseInt(s[0]),a=n&Pr,p=n&jr,c=n&$r,m=n&Br,f=a?Object.create(null):{};this.siero.serializer.deserialized(f,t);let g=this.siero.packer.unpack(s[1]),S=h(this.siero.serializer.deserialize(s[2],i,t)),b=h(this.siero.serializer.deserialize(s[3],i,t)),I=h(this.siero.serializer.deserialize(s[4],i,t));for(let d=0,O=g.length;d<O;d++)f[g[d]]=S[d];for(let d=0,O=b.length;d<O;d++)f[b[d]]=I[d];return p||Object.preventExtensions(f),c&&Object.freeze(f),m&&Object.seal(f),f}},Nr=$e;var Mr=[Le,We,Ke,Ge,He,Ye,Xe,Ze,qe,Je,Qe,_e,er,rr,tr,ir,sr,or,pr,cr,mr,ur,fr,dr,zr,yr,xr,hr,gr,Sr,br,Cr,wr,Or,kr,Ir,Dr,Ar,Tr,Rr,Er,vr,Nr];var Be=class extends y{constructor(e){super(e);this.infer=(e,i)=>{if(e===null)return this.value2type.get(e);let t=typeof e,s=e?.constructor;return(t==="object"||t==="function")&&this.reference.isSerialized(e,i)?this.reference:t==="object"&&s!==void 0?this.constructor2type.get(s):this.typeof2type.get(t)};this.normalize=(e,i,t,s)=>{try{let n=this.serialize(i,t,s);return[e,this.serialized2.wrap(n)]}catch(n){return this.normalize(!1,n,t,s)}};this.serialized=(e,i)=>{this.reference.serialized(e,i)};this.deserialized=(e,i)=>{this.reference.deserialized(e,i)};this.serialize=(e,i,t)=>{let s=this.infer(e,t);if(!s)throw new Error("Unserializable value");let n=this.type2id.get(s),a=s.serialize(e,i,t);return`${n}${a}`};this.deserialize=(e,i,t)=>{let s=e[0],n=e.slice(1),a=this.id2type.get(s);if(!a)throw new Error("Undeserializable value");return a.deserialize(n,i,t)};let i="@ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=Mr;if(t.length>=i.length)throw new Error(`More than ${i.length} types are not supported`);this.types=t.map(s=>new s(e)),this.type2id=new Map(this.types.map((s,n)=>[s,i[n]])),this.id2type=new Map(this.types.map((s,n)=>[i[n],s])),this.typeof2type=new Map(this.types.map(s=>[s.typeof,s])),this.constructor2type=new Map(this.types.map(s=>[s.Constructor,s])),this.value2type=new Map(this.types.map(s=>[s.value,s])),this.reference=this.types[0],this.serialized2=this.types[1]}},Fr=Be;var Ne=class{constructor(r={}){this.call=(r,e)=>{this.commands.call(r,e)};this.register=(r,e)=>this.realms.register(r,e);this.serialize=(r,e={})=>this.serializer.serialize(r,e,new w);this.deserialize=(r,e={})=>this.serializer.deserialize(r,e,new w);this.realm=r.realm??ar(),this.commands=new Me(this),this.contexts=new Fe(this),this.packer=new Ue(this),this.realms=new Ve(this),this.serializer=new Fr(this)}},qr=Ne;return Gr(Jr);};
